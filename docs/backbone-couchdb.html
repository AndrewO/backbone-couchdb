<!DOCTYPE html>  <html> <head>   <title>backbone-couchdb.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-couchdb.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>I developed this connector because I didn't want to write an own server that persists 
the models that Backbone.js ceated. Instead I now only have to write a simple design document 
containing one simple view and I'm done with server-side code. 
So have fun reading the doc and <a href="http://vimeo.com/11852209">RELAX</a> :D</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>I added the connector to the Backbone object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Name of the Database.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">databaseName</span> <span class="o">:</span> <span class="s2">&quot;test1&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Name of the design document that contains the views.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">ddocName</span> <span class="o">:</span> <span class="s2">&quot;backbone&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>Name of the view.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">viewName</span> <span class="o">:</span> <span class="s2">&quot;byCollection&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>You shouldn't use this now since it will not work properly.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">enableChanges</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>If <code>baseUrl</code> is set, the default uri of jquery.couch.js will be overridden.
This is useful if you want to access a couch on another server e.g. <code>http://127.0.0.1:5984</code>
Important: Be aware of the Cross-Origin Policy. </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">baseUrl</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>A simple lookup table for collections that should be synched.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_watchList</span> <span class="o">:</span> <span class="p">[],</span>
	<span class="nx">getCollectionFromModel</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>I would like to use the Backbone <code>getUrl()</code> helper here but it's not in my scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">model</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> 
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No url property/function!&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">collectionName</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">?</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="o">:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
		<span class="nx">collectionName</span> <span class="o">=</span> <span class="nx">collectionName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">split</span> <span class="o">=</span> <span class="nx">collectionName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>jquery.couch.js adds the id itself, so we delete the id if it is in the url.
"collection/:id" -> "collection"</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">split</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
			<span class="nx">collectionName</span> <span class="o">=</span> <span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">collectionName</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>Creates a couchDB object from the given model object.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">makeDb</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">){</span>
			<span class="nx">db</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseName</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">db</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>Fetches all docs from the given collection.
Therefore all docs from the view <code>ddocName</code>/<code>viewName</code> will be requested.
A simple view could look like this:
function(doc) {
    if(doc.collection) 
    emit(doc.collection, doc);
}
doc.collection represents the url property of the collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">read</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">_success</span><span class="p">,</span> <span class="nx">_error</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeDb</span><span class="p">(</span><span class="nx">coll</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollectionFromModel</span><span class="p">(</span><span class="nx">coll</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ddocName</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewName</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>Query equals ddocName/viewName </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="nx">query</span><span class="p">,{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>Only return docs that have this collection's name as key.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">keys</span> <span class="o">:</span> <span class="p">[</span><span class="nx">collection</span><span class="p">],</span>
			<span class="nx">include_docs</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
			<span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
					<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <p>Prepare the result set for Backbon -> Only return the docs and no meta data.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">doc</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="nx">_success</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
				<span class="p">}</span><span class="k">else</span><span class="p">{</span>
					<span class="nx">_success</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">},</span>
			<span class="nx">error</span><span class="o">:</span> <span class="nx">_error</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <p>Add the collection to the <code>_watchlist</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_watchList</span><span class="p">[</span><span class="nx">collection</span><span class="p">]){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">_watchList</span><span class="p">[</span><span class="nx">collection</span><span class="p">]</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">;</span>			
		<span class="p">}</span>

	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>Creates a document.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">create</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">_success</span><span class="p">,</span> <span class="nx">_error</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeDb</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">collection</span><span class="p">){</span>
			<span class="nx">data</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollectionFromModel</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">_id</span><span class="p">){</span>
			<span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>jquery.couch.js automatically finds out whether the document is new 
or already exists by checking for the _id property.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">db</span><span class="p">.</span><span class="nx">saveDoc</span><span class="p">(</span><span class="nx">data</span><span class="p">,{</span>
			<span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <p>When the document has been successfully created/altered, return
the created/changed values. Backbone finds out that an element has been
synched by checking for the existance of an <code>id</code> property in the model.
By returning the an object with an <code>id</code> we mark the model as synched.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
					<span class="nx">_success</span><span class="p">({</span>
						<span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
						<span class="s2">&quot;_rev&quot;</span> <span class="o">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">rev</span>
					<span class="p">});</span>
				<span class="k">else</span>
					<span class="nx">_success</span><span class="p">({</span>
						<span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
						<span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
						<span class="s2">&quot;_rev&quot;</span> <span class="o">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">rev</span>
					<span class="p">});</span>
			<span class="p">},</span>
			<span class="nx">error</span> <span class="o">:</span> <span class="nx">_error</span>
		<span class="p">});</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-20">#</a>               </div>               <p>jquery.couch.js provides the same method for updating and creating a document, 
so we can use the <code>create</code> method here.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">update</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">_success</span><span class="p">,</span> <span class="nx">_error</span><span class="p">){</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">_success</span><span class="p">,</span> <span class="nx">_error</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-21">#</a>               </div>               <p>Deletes the document via the removeDoc method.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">delete</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">_success</span><span class="p">,</span> <span class="nx">_error</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeDb</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
		<span class="nx">db</span><span class="p">.</span><span class="nx">removeDoc</span><span class="p">(</span><span class="nx">data</span><span class="p">,{</span>
			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
				<span class="nx">_success</span><span class="p">();</span>
			<span class="p">},</span>
			<span class="nx">error</span><span class="o">:</span> <span class="nx">_error</span>
		<span class="p">});</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-22">#</a>               </div>               <p><strong>This feature is in development. You may enable it but it doesn't work correctly.</strong>
The _changes feed is one of the coolest things about CouchDB in my opinion.
It enables you to get real time updates of changes in your database.
If <code>enableChanges</code> is true the connector automatically listens to changes in the database 
and updates the changed models. -> Remotely triggered <code>change</code> events in your models. YES!</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">_changes</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeDb</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">connector</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-23">#</a>               </div>               <p>First grab the <code>update_seq</code> from the database info, so that we only receive newest changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">db</span><span class="p">.</span><span class="nx">info</span><span class="p">({</span>
			<span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
				<span class="kd">var</span> <span class="nx">since</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">update_seq</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-24">#</a>               </div>               <p>Connect to the changes feed.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">connector</span><span class="p">.</span><span class="nx">changesFeed</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">(</span><span class="nx">since</span><span class="p">,{</span><span class="nx">include_docs</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
				<span class="nx">connector</span><span class="p">.</span><span class="nx">changesFeed</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">changes</span><span class="p">){</span>
					<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;changes: &quot;</span><span class="p">,</span> <span class="nx">changes</span><span class="p">);</span>
					<span class="kd">var</span> <span class="nx">doc</span><span class="p">,</span><span class="nx">coll</span><span class="p">,</span><span class="nx">model</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-25">#</a>               </div>               <p>Iterate over the changed docs and validate them.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">doc</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">doc</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">collection</span><span class="p">){</span>
							<span class="nx">coll</span> <span class="o">=</span> <span class="nx">connector</span><span class="p">.</span><span class="nx">_watchList</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">collection</span><span class="p">];</span>
							<span class="k">if</span><span class="p">(</span><span class="nx">coll</span><span class="p">){</span>
								<span class="nx">model</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
								<span class="k">if</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-26">#</a>               </div>               <p>Currently all properties are updated, will diff in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
								<span class="p">}</span><span class="k">else</span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-27">#</a>               </div>               <p>EXPERIMENTAL, WILL BREAK </p>             </td>             <td class="code">               <div class="highlight"><pre>									<span class="nx">coll</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">});</span>
			<span class="p">}</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-28">#</a>               </div>               <p>Override the standard sync method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span><span class="p">){</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span><span class="nx">success</span><span class="p">,</span><span class="nx">error</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;read&quot;</span><span class="p">){</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span><span class="nx">success</span><span class="p">,</span><span class="nx">error</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">){</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span><span class="nx">success</span><span class="p">,</span><span class="nx">error</span><span class="p">);</span>
	<span class="p">}</span>
	</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-29">#</a>               </div>               <p>Activate real time changes feed</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="nx">enableChanges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="nx">changesFeed</span><span class="p">){</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">couchConnector</span><span class="p">.</span><span class="nx">_changes</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
	<span class="p">}</span>	
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 